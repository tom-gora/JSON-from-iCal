---
import NeoButton from "./NeoButton.astro"
const squareIconSize = 22
const props = Astro.props

const closeSVG = `<svg xmlns="http://www.w3.org/2000/svg" width="${squareIconSize}" height="${squareIconSize}" viewBox="0 0 24 24" {...props}>
	<path fill="currentColor" d="M20 6.91L17.09 4L12 9.09L6.91 4L4 6.91L9.09 12L4 17.09L6.91 20L12 14.91L17.09 20L20 17.09L14.91 12z" />
</svg>`
---
<div class="max-w-4xl mx-auto">
  <form id="text-input-form" class="space-y-6">
    <div class="flex flex-col gap-2">
      <label class="text-2xl font-black uppercase">
        Raw iCal Content
      </label>
      <textarea
        name="text"
        id="ical-content-textarea"
        class="neo-input min-h-[300px] font-mono text-sm"
        placeholder="BEGIN:VCALENDAR..."
        required
      ></textarea>
    </div>

    <NeoButton
      type="submit"
      id="text-submit-btn"
      class="neo-button w-full text-2xl py-6 bg-white text-black dark:bg-neo-pink hover:opacity-90 flex items-center justify-center gap-4"
    >
      <span class="btn-text">Process Calendar</span>
      <div class="loading-spinner hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="animate-spin">
          <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3a9 9 0 1 0 9 9" />
        </svg>
      </div>
    </NeoButton>

    <div id="text-error-box" class="opacity-0 h-0 pointer-events-none transition-all duration-300 overflow-hidden p-0 neo-border bg-[#dd8181] text-white flex flex-col gap-2">
      <div class="flex items-center justify-between p-4 pb-0">
        <span class="font-bold uppercase text-sm">Notice</span>
      <NeoButton 
        type="button" 
        id="close-text-error-btn"
        class="neo-button-sm close p-0 text-xs font-bold"
        title="Close Error Message Box"
        svgString={closeSVG}
      />

      </div>
      <p id="text-error-message" class="text-sm italic p-4 pt-0"></p>
    </div>
  </form>
</div>

<script>
  const form = document.getElementById('text-input-form') as HTMLFormElement;
  const submitBtn = document.getElementById('text-submit-btn') as HTMLButtonElement;
  const btnText = submitBtn.querySelector('.btn-text') as HTMLElement;
  const spinner = submitBtn.querySelector('.loading-spinner') as HTMLElement;
  const errorBox = document.getElementById('text-error-box') as HTMLElement;
  const errorMsg = document.getElementById('text-error-message') as HTMLElement;
  const closeErrorBtn = document.getElementById('close-text-error-btn') as HTMLElement;

  function showError(msg: string) {
    document.querySelector("#json-wrapper")?.classList.remove("active");

    errorMsg.innerText = msg;
    errorBox.classList.remove('opacity-0', 'h-0', 'pointer-events-none');
    errorBox.classList.add('opacity-100', 'h-auto', 'pointer-events-auto', 'mt-6');
    errorBox.scrollIntoView({
      behavior: 'smooth',
      block: 'center', 
    })
  }

  function hideError() {
    errorBox.classList.add('opacity-0', 'h-0', 'pointer-events-none');
    errorBox.classList.remove('opacity-100', 'h-auto', 'pointer-events-auto', 'mt-6');
  }

  closeErrorBtn?.addEventListener('click', hideError);

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Scrape config from the DOM
    const lookaheadInput = document.getElementById('lookahead-input') as HTMLInputElement;
    const limitInput = document.getElementById('limit-input') as HTMLInputElement;
    const templateInput = document.getElementById('template-input') as HTMLInputElement;
    const markerTodayInput = document.getElementById('marker-today-input') as HTMLInputElement;
    const markerTomorrowInput = document.getElementById('marker-tomorrow-input') as HTMLInputElement;

    const text = (document.getElementById('ical-content-textarea') as HTMLTextAreaElement).value;
    
    hideError();
    submitBtn.disabled = true;
    btnText.innerText = 'Processing...';
    spinner.classList.remove('hidden');

    const offsetMarkers: Record<string, string> = {};
    if (markerTodayInput?.value) offsetMarkers['0'] = markerTodayInput.value;
    if (markerTomorrowInput?.value) offsetMarkers['1'] = markerTomorrowInput.value;

    try {
      const response = await fetch('/api/process-text', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text,
          options: { 
            upcomingDays: parseInt(lookaheadInput?.value || '7'), 
            limit: parseInt(limitInput?.value || '0'),
            template: templateInput?.value || '',
            offsetMarkers
          }
        })
      });
      
      const result = await response.json();

      if (response.ok) {
        const { data, logs, verbose } = result;
        if (data.length === 0) {
          const msg = logs 
            ? `No upcoming events found.\n\nSystem Logs:\n${logs}`
            : 'No upcoming events found for this calendar in the given range.';
          
          if (verbose) {
            alert(msg);
          } else {
            showError('No upcoming events found for this calendar in the given range.');
          }
        } else {
          console.log('[TextInputForm] Dispatching jsoon:show-events with', data.length, 'events');
          window.dispatchEvent(new CustomEvent('jsoon:show-events', { detail: data }));
        }
      } else {
        const msg = result.error || 'Unknown error';
        if (result.verbose) {
          alert(`Error: ${msg}`);
        } else {
          showError(`Error: ${msg}`);
        }
      }
    } catch (err: any) {
      showError(`Failed to process text: ${err.message}`);
    } finally {
      submitBtn.disabled = false;
      btnText.innerText = 'Process Calendar';
      spinner.classList.add('hidden');
    }
  });
</script>
