---
import NeoButton from "./NeoButton.astro"
import { ICONS } from "../lib/icons"

const props = Astro.props
---
<div class="max-w-4xl mx-auto">
  <div class="mb-8 p-6 neo-border bg-white/50 dark:bg-neo-dark/50 text-black dark:text-white">
    <p class="font-bold mb-4 italic text-sm md:text-base">
      If you have no URL to an .ics file at hand and you can't be bothered
      to look for one, here's some:
    </p>
    <div class="flex flex-col gap-3">
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 p-3 bg-white dark:bg-neo-dark neo-border border-2">
        <span class="font-black flex items-center gap-2 uppercase text-xs"><Fragment set:html={ICONS.moon} /> Moon Phases</span>
        <code class="text-[10px] md:text-xs truncate bg-gray-100 dark:bg-zinc-700 p-1 flex-grow mx-2">
          https://mooncal.ch/mooncal.ics...
        </code>
        <NeoButton
          type="button"
          data-url="https://mooncal.ch/mooncal.ics?created=65885508461&lang=en&phases[full]=true&phases[new]=false&phases[quarter]=false&phases[daily]=false&style=withDescription&events[lunareclipse]=true&events[solareclipse]=true&events[moonlanding]=true&before=P6M&after=P2Y&zone=Europe/London"
          class="example-btn neo-button py-1 px-3 min-w-32 text-[10px] bg-neo-purple text-white dark:bg-neo-pink dark:text-black"
        >
          Copy to form
        </NeoButton>
      </div>
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 p-3 bg-white dark:bg-neo-dark neo-border border-2">
        <span class="font-black flex items-center gap-2 uppercase text-xs"><Fragment set:html={ICONS.cuppa} /> UK Holidays</span>
        <code class="text-[10px] md:text-xs truncate bg-gray-100 dark:bg-zinc-700 p-1 flex-grow mx-2">
          https://calendar.google.com/calendar/ical...
        </code>
        <NeoButton
          type="button"
          data-url="https://calendar.google.com/calendar/ical/en.uk%23holiday%40group.v.calendar.google.com/public/basic.ics"
          class="example-btn neo-button py-1 px-3 min-w-32 text-[10px] bg-neo-purple text-white dark:bg-neo-pink dark:text-black"
        >
          Copy to form
        </NeoButton>
      </div>
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 p-3 bg-white dark:bg-neo-dark neo-border border-2">
        <span class="font-black flex items-center gap-2 uppercase text-xs"><Fragment set:html={ICONS.burger} /> USA Holidays</span>
        <code class="text-[10px] md:text-xs truncate bg-gray-100 dark:bg-zinc-700 p-1 flex-grow mx-2">
          https://calendar.google.com/calendar/ical...
        </code>
        <NeoButton
          type="button"
          data-url="https://calendar.google.com/calendar/ical/en.usa%23holiday%40group.v.calendar.google.com/public/basic.ics"
          class="example-btn neo-button py-1 px-3 min-w-32 text-[10px] bg-neo-purple text-white dark:bg-neo-pink dark:text-black"
        >
          Copy to form
        </NeoButton>
      </div>
    </div>
  </div>

  <form id="url-input-form" class="space-y-6">
    <div id="url-list-container" class="flex flex-col gap-4">
      <label class="text-2xl font-black uppercase">Calendar URLs</label>
      <div class="url-row flex gap-4">
        <NeoButton 
          type="button"
          class="clear-btn neo-button-sm grid place-items-center bg-[#dd8181] text-white px-4 hidden"
          svgString={ICONS.clear}>
        </NeoButton>
        <input
          type="url"
          name="url"
          class="neo-input flex-grow"
          required
        />
        <NeoButton 
          type="button"
          class="remove-btn neo-button-sm grid place-items-center close text-white px-4 hidden"
          svgString={ICONS.close}>
        </NeoButton>
      </div>
    </div>

    <NeoButton
      type="button"
      id="add-url-btn"
      class="neo-button bg-white text-black dark:bg-neo-purple dark:text-white self-start"
    >
      + Add URL
    </NeoButton>

    <NeoButton
      type="submit"
      id="url-submit-btn"
      class="neo-button w-full text-2xl py-6 bg-white text-black dark:bg-neo-pink hover:opacity-90 flex items-center justify-center gap-4"
    >
      <span class="btn-text">Fetch Calendars</span>
      <div class="loading-spinner hidden">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="animate-spin">
          <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3a9 9 0 1 0 9 9" />
        </svg>
      </div>
    </NeoButton>

    <div id="error-box" class="opacity-0 h-0 pointer-events-none transition-all duration-300 overflow-hidden p-0 neo-border error-box text-white flex flex-col gap-2">
      <div class="flex items-center justify-between p-4 pb-0">
        <span class="font-bold uppercase text-sm">Notice</span>
      <NeoButton 
        type="button" 
        id="close-error-btn"
        class="neo-button-sm close p-0 text-xs font-bold"
        title="Close Error Message Box"
        svgString={ICONS.close}
      />

      </div>
      <p id="error-message" class="text-sm italic p-4 pt-0"></p>
    </div>
  </form>
</div>

<template id="url-row-template">
  <div class="url-row flex gap-4 animate-in fade-in slide-in-from-left-4 duration-200">
    <NeoButton 
      type="button"
      class="clear-btn neo-button-sm grid place-items-center bg-[#dd8181] text-white px-4 hidden"
      svgString={ICONS.clear}>
    </NeoButton>
    <input
      type="url"
      name="url"
      class="neo-input flex-grow"
      required
    />
    <NeoButton 
      type="button"
      class="remove-btn !width-[3rem] neo-button-sm grid place-items-center close text-white px-4 hidden"
      svgString={ICONS.close}>
    </NeoButton>
  </div>
</template>

<script>
  const form = document.getElementById('url-input-form') as HTMLFormElement;
  const urlList = document.getElementById('url-list-container');
  const addBtn = document.getElementById('add-url-btn');
  const template = document.getElementById('url-row-template') as HTMLTemplateElement;
  const submitBtn = document.getElementById('url-submit-btn') as HTMLButtonElement;
  const btnText = submitBtn.querySelector('.btn-text') as HTMLElement;
  const spinner = submitBtn.querySelector('.loading-spinner') as HTMLElement;
  const errorBox = document.getElementById('error-box') as HTMLElement;
  const errorMsg = document.getElementById('error-message') as HTMLElement;
  const closeErrorBtn = document.getElementById('close-error-btn') as HTMLElement;

  function showError(msg: string) {
    document.querySelector("#json-wrapper")?.classList.remove("active");
    
    errorMsg.innerText = msg;
    errorBox.classList.remove('opacity-0', 'h-0', 'pointer-events-none');
    errorBox.classList.add('opacity-100', 'h-auto', 'pointer-events-auto', 'mt-6');
    errorBox.scrollIntoView({
      behavior: 'smooth',
      block: 'center', 
    })

  }

  function hideError() {
    errorBox.classList.add('opacity-0', 'h-0', 'pointer-events-none');
    errorBox.classList.remove('opacity-100', 'h-auto', 'pointer-events-auto', 'mt-6');
  }

  closeErrorBtn?.addEventListener('click', hideError);

  function updateClearButton(input: HTMLInputElement) {
    const row = input.closest('.url-row');
    const clearBtn = row?.querySelector('.clear-btn');
    if (input.value.trim()) {
      clearBtn?.classList.remove('hidden');
    } else {
      clearBtn?.classList.add('hidden');
    }
  }

  function updateRemoveButtons() {
    const rows = document.querySelectorAll('.url-row');
    rows.forEach(row => {
      const removeBtn = row.querySelector('.remove-btn');
      if (rows.length === 1) {
        removeBtn?.classList.add('hidden');
      } else {
        removeBtn?.classList.remove('hidden');
      }
    });
    
    if (rows.length >= 5) {
      addBtn?.classList.add('hidden');
    } else {
      addBtn?.classList.remove('hidden');
    }
  }

  addBtn?.addEventListener('click', () => {
    const rows = document.querySelectorAll('.url-row');
    if (rows.length < 5 && template) {
      const clone = template.content.cloneNode(true) as HTMLElement;
      urlList?.appendChild(clone);
      updateRemoveButtons();
    }
  });

  urlList?.addEventListener('input', (e) => {
    const target = e.target as HTMLInputElement;
    if (target.name === 'url') {
      updateClearButton(target);
    }
  });

  urlList?.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    
    // Clear logic
    const clearBtn = target.closest('.clear-btn');
    if (clearBtn) {
      const row = clearBtn.closest('.url-row');
      const input = row?.querySelector('input[name="url"]') as HTMLInputElement;
      if (input) {
        input.value = '';
        updateClearButton(input);
        input.focus();
      }
      return;
    }

    // Remove logic
    if (target.classList.contains('remove-btn') || target.closest('.remove-btn')) {
      target.closest('.url-row')?.remove();
      updateRemoveButtons();
    }
  });

  document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const url = btn.getAttribute('data-url');
      if (!url) return;

      const inputs = document.querySelectorAll('input[name="url"]') as NodeListOf<HTMLInputElement>;
      let filled = false;
      
      // Try to fill first empty input
      for (const input of inputs) {
        if (!input.value) {
          input.value = url;
          updateClearButton(input);
          filled = true;
          break;
        }
      }

      // If all filled and < 5, add new one
      if (!filled && inputs.length < 5) {
        addBtn?.click();
        const newInputs = document.querySelectorAll('input[name="url"]') as NodeListOf<HTMLInputElement>;
        const lastInput = newInputs[newInputs.length - 1];
        lastInput.value = url;
        updateClearButton(lastInput);
      }
    });
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const lookaheadInput = document.getElementById('lookahead-input') as HTMLInputElement;
    const limitInput = document.getElementById('limit-input') as HTMLInputElement;
    const templateInput = document.getElementById('template-input') as HTMLInputElement;
    const markerTodayInput = document.getElementById('marker-today-input') as HTMLInputElement;
    const markerTomorrowInput = document.getElementById('marker-tomorrow-input') as HTMLInputElement;

    const inputs = document.querySelectorAll('input[name="url"]') as NodeListOf<HTMLInputElement>;
    const urls = Array.from(inputs).map(i => i.value).filter(v => v.trim() !== '');
    
    hideError();
    submitBtn.disabled = true;
    btnText.innerText = 'Fetching...';
    spinner.classList.remove('hidden');

    const offsetMarkers: Record<string, string> = {};
    if (markerTodayInput?.value) offsetMarkers['0'] = markerTodayInput.value;
    if (markerTomorrowInput?.value) offsetMarkers['1'] = markerTomorrowInput.value;

    try {
      const response = await fetch('/api/process-urls', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          urls,
          options: { 
            upcomingDays: parseInt(lookaheadInput?.value || '7'), 
            limit: parseInt(limitInput?.value || '0'),
            template: templateInput?.value || '',
            offsetMarkers
          }
        })
      });
      
      const result = await response.json();

      if (response.ok) {
        const { data, logs, verbose } = result;
        if (data.length === 0) {
          const msg = logs 
            ? `No upcoming events found.\n\nSystem Logs:\n${logs}`
            : 'No upcoming events found for these calendars in the given range.';
          
          if (verbose) {
            alert(msg);
          } else {
            showError('No upcoming events found for these calendars in the given range.');
          }
        } else {
          console.log('[UrlInputForm] Dispatching jsoon:show-events with', data.length, 'events');
          window.dispatchEvent(new CustomEvent('jsoon:show-events', { detail: data }));
        }
      } else {
        const msg = result.error || 'Unknown error';
        if (result.verbose) {
          alert(`Error: ${msg}`);
        } else {
          showError(`Error: ${msg}`);
        }
      }
    } catch (err: any) {
      showError(`Failed to process URLs: ${err.message}`);
    } finally {
      submitBtn.disabled = false;
      btnText.innerText = 'Fetch Calendars';
      spinner.classList.add('hidden');
    }
  });
</script>
