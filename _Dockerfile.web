# Stage 1: Build Go Binary
FROM golang:1.24-alpine AS go-builder
WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download
# Copy only Go source to avoid bloat
COPY cmd/ ./cmd/
COPY internal/ ./internal/
RUN go build -o jsoon ./cmd/j-soon/main.go

# Stage 2: Build Frontend
FROM node:22-alpine AS node-builder
WORKDIR /app
# Copy only package files first
COPY _web_showcase/package*.json ./
RUN npm install
# Copy only necessary frontend source
COPY _web_showcase/src/ ./src/
COPY _web_showcase/public/ ./public/
COPY _web_showcase/astro.config.mjs ./
COPY _web_showcase/tsconfig.json ./
RUN npm run build

# Stage 3: Final Runtime (Plain Node Alpine)
FROM node:22-alpine
WORKDIR /app

# 1. Copy Go binary
COPY --from=go-builder /src/jsoon /app/bin/jsoon

# 2. Copy built frontend
COPY --from=node-builder /app/dist /app/dist
COPY --from=node-builder /app/package.json /app/package.json

# 3. Install production dependencies
RUN npm install --omit=dev && npm cache clean --force

# Environment
ENV NODE_ENV=production
ENV HOST=0.0.0.0
ENV PORT=4322
ENV JSOON_BIN=/app/bin/jsoon
ENV JSOON_WEB_VERBOSE=false

EXPOSE 4322

CMD ["node", "./dist/server/entry.mjs"]
